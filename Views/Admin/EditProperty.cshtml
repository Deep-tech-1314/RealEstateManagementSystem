@model RealEstateManagementSystem.ViewModels.PropertyViewModel
@{
    ViewData["Title"] = "Edit Property";
}

<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="fas fa-edit"></i> Edit Property</h4>
                </div>
                <div class="card-body">
                    <form asp-action="EditProperty" method="post" enctype="multipart/form-data">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="PropertyId" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-12 mb-4">
                                <h5 class="border-bottom pb-2"><i class="fas fa-info-circle"></i> Basic Information</h5>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Title" class="form-label">Property Title *</label>
                                <input asp-for="Title" class="form-control" placeholder="e.g., Beautiful 3BR House in Downtown">
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="PropertyType" class="form-label">Property Type *</label>
                                <select asp-for="PropertyType" class="form-select">
                                    <option value="">Select Type</option>
                                    <option value="House">House</option>
                                    <option value="Apartment">Apartment</option>
                                    <option value="Villa">Villa</option>
                                    <option value="Commercial">Commercial</option>
                                    <option value="Land">Land</option>
                                </select>
                                <span asp-validation-for="PropertyType" class="text-danger"></span>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="ListingType" class="form-label">Listing Type *</label>
                                <select asp-for="ListingType" class="form-select">
                                    <option value="">Select Type</option>
                                    <option value="Sale">For Sale</option>
                                    <option value="Rent">For Rent</option>
                                </select>
                                <span asp-validation-for="ListingType" class="text-danger"></span>
                            </div>

                            <div class="col-12 mb-3">
                                <label asp-for="Description" class="form-label">Description *</label>
                                <textarea asp-for="Description" class="form-control" rows="4" placeholder="Describe the property in detail..."></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <!-- Price & Location -->
                            <div class="col-12 mb-4 mt-3">
                                <h5 class="border-bottom pb-2"><i class="fas fa-dollar-sign"></i> Price & Location</h5>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="Price" class="form-label">Price ($) *</label>
                                <input asp-for="Price" type="number" class="form-control" placeholder="e.g., 250000">
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>

                            <div class="col-md-9 mb-3">
                                <label asp-for="Address" class="form-label">Street Address *</label>
                                <input asp-for="Address" class="form-control" placeholder="e.g., 123 Main Street">
                                <span asp-validation-for="Address" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="City" class="form-label">City *</label>
                                <input asp-for="City" class="form-control" placeholder="e.g., New York">
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="State" class="form-label">State *</label>
                                <input asp-for="State" class="form-control" placeholder="e.g., NY">
                                <span asp-validation-for="State" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="ZipCode" class="form-label">Zip Code *</label>
                                <input asp-for="ZipCode" class="form-control" placeholder="e.g., 10001">
                                <span asp-validation-for="ZipCode" class="text-danger"></span>
                            </div>

                            <!-- Property Details -->
                            <div class="col-12 mb-4 mt-3">
                                <h5 class="border-bottom pb-2"><i class="fas fa-th"></i> Property Details</h5>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="Bedrooms" class="form-label">Bedrooms</label>
                                <input asp-for="Bedrooms" type="number" class="form-control" placeholder="e.g., 3">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="Bathrooms" class="form-label">Bathrooms</label>
                                <input asp-for="Bathrooms" type="number" class="form-control" placeholder="e.g., 2">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="SquareFeet" class="form-label">Square Feet</label>
                                <input asp-for="SquareFeet" type="number" class="form-control" placeholder="e.g., 1500">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="YearBuilt" class="form-label">Year Built</label>
                                <input asp-for="YearBuilt" type="number" class="form-control" placeholder="e.g., 2020">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="ParkingSpaces" class="form-label">Parking Spaces</label>
                                <input asp-for="ParkingSpaces" class="form-control" placeholder="e.g., 2-car garage">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Features" class="form-label">Features (comma-separated)</label>
                                <input asp-for="Features" class="form-control" placeholder="e.g., Pool, Garden, Balcony">
                                <small class="text-muted">Separate features with commas</small>
                            </div>

                            <!-- Current Images -->
                            <div class="col-12 mb-4 mt-3">
                                <h5 class="border-bottom pb-2"><i class="fas fa-images"></i> Current Images</h5>
                            </div>

                            @if (!string.IsNullOrEmpty(ViewBag.MainImage as string))
                            {
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Current Main Image</label>
                                    <div class="position-relative">
                                        <img src="@ViewBag.MainImage" class="img-fluid rounded" style="max-height: 200px;" alt="Main Image">
                                        @if (!ViewBag.MainImage.ToString().Contains("default-property.jpg"))
                                        {
                                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                                    onclick="deletePhoto(@Model.PropertyId, '@ViewBag.MainImage', true)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(ViewBag.AdditionalImages as string))
                            {
                                <div class="col-12 mb-3">
                                    <label class="form-label">Current Additional Images</label>
                                    <div class="row" id="additionalImagesContainer">
                                        @foreach (var img in ((string)ViewBag.AdditionalImages).Split(','))
                                        {
                                            <div class="col-md-2 mb-2 position-relative">
                                                <img src="@img" class="img-fluid rounded" style="height: 100px; width: 100%; object-fit: cover;" alt="Additional">
                                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                                                        onclick="deletePhoto(@Model.PropertyId, '@img', false)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Upload New Images -->
                            <div class="col-12 mb-3">
                                <h5 class="border-bottom pb-2"><i class="fas fa-upload"></i> Upload New Images</h5>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="MainImage" class="form-label">New Main Image</label>
                                <input asp-for="MainImage" type="file" class="form-control" accept="image/*" id="mainImageInput">
                                <small class="text-muted">Leave empty to keep current image</small>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-primary" onclick="uploadMainImage(@Model.PropertyId)">
                                        <i class="fas fa-upload"></i> Upload Main Image
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="AdditionalImages" class="form-label">New Additional Images</label>
                                <input asp-for="AdditionalImages" type="file" class="form-control" accept="image/*" multiple id="additionalImagesInput">
                                <small class="text-muted">Select multiple images</small>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-primary" onclick="uploadAdditionalImages(@Model.PropertyId)">
                                        <i class="fas fa-upload"></i> Upload Additional Images
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    <input asp-for="KeepExistingImages" class="form-check-input" type="checkbox" checked>
                                    <label asp-for="KeepExistingImages" class="form-check-label">Keep existing additional images when uploading new ones</label>
                                </div>
                            </div>

                            <!-- Status & Featured -->
                            <div class="col-12 mb-4 mt-3">
                                <h5 class="border-bottom pb-2"><i class="fas fa-cog"></i> Settings</h5>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Status" class="form-label">Status</label>
                                <select asp-for="Status" class="form-select">
                                    <option value="Available">Available</option>
                                    <option value="Sold">Sold</option>
                                    <option value="Rented">Rented</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label d-block">Featured Property</label>
                                <div class="form-check form-switch">
                                    <input asp-for="IsFeatured" class="form-check-input" type="checkbox">
                                    <label asp-for="IsFeatured" class="form-check-label">Mark as featured (shown on homepage)</label>
                                </div>
                            </div>

                            <!-- Buttons -->
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-warning btn-lg px-5">
                                    <i class="fas fa-save"></i> Update Property
                                </button>
                                <a asp-action="Properties" class="btn btn-secondary btn-lg px-5">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <button type="button" class="btn btn-danger btn-lg px-5" onclick="deleteProperty(@Model.Id)">
                                    <i class="fas fa-trash"></i> Delete Property
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        function deleteProperty(propertyId) {
            if (confirm('Are you sure you want to delete this property? This action cannot be undone!')) {
                fetch('/Admin/DeleteProperty/' + propertyId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Property deleted successfully!');
                        window.location.href = '/Admin/Properties';
                    } else {
                        alert('Failed to delete property');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        }
        
        // Photo Management Functions
        function deletePhoto(propertyId, photoPath, isMainImage) {
            if (confirm('Are you sure you want to delete this photo? This action cannot be undone!')) {
                // Create form data
                const formData = new FormData();
                formData.append('propertyId', propertyId);
                formData.append('photoPath', photoPath);
                formData.append('isMainImage', isMainImage);
                
                // Send request to delete the photo
                fetch('/Admin/DeletePhoto', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the page to show updated images
                        location.reload();
                    } else {
                        alert('Failed to delete photo: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the photo');
                });
            }
        }
        
        function uploadMainImage(propertyId) {
            const fileInput = document.getElementById('mainImageInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to upload');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('propertyId', propertyId);
            formData.append('photo', file);
            formData.append('isMainImage', true);
            
            // Show loading indicator
            const uploadButton = fileInput.nextElementSibling.nextElementSibling.querySelector('button');
            const originalText = uploadButton.innerHTML;
            uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            uploadButton.disabled = true;
            
            fetch('/Admin/AddPhoto', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh the page to show updated images
                    location.reload();
                } else {
                    alert('Failed to upload image: ' + (data.message || 'Unknown error'));
                    // Reset button
                    uploadButton.innerHTML = originalText;
                    uploadButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while uploading the image');
                // Reset button
                uploadButton.innerHTML = originalText;
                uploadButton.disabled = false;
            });
        }
        
        function uploadAdditionalImages(propertyId) {
            const fileInput = document.getElementById('additionalImagesInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            // Show loading indicator
            const uploadButton = fileInput.nextElementSibling.nextElementSibling.querySelector('button');
            const originalText = uploadButton.innerHTML;
            uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            uploadButton.disabled = true;
            
            // Track upload progress
            let uploadedCount = 0;
            const totalFiles = fileInput.files.length;
            
            // Process each file
            Array.from(fileInput.files).forEach(file => {
                const formData = new FormData();
                formData.append('propertyId', propertyId);
                formData.append('photo', file);
                formData.append('isMainImage', false);
                
                fetch('/Admin/AddPhoto', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    uploadedCount++;
                    
                    if (uploadedCount === totalFiles) {
                        // All files processed, refresh the page
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    uploadedCount++;
                    
                    if (uploadedCount === totalFiles) {
                        // All files processed, refresh the page
                        location.reload();
                    }
                });
            });
        }
    </script>
}