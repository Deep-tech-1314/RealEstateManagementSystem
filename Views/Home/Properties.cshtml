@model RealEstateManagementSystem.ViewModels.PropertyListViewModel
@using RealEstateManagementSystem.Services
@{
    ViewData["Title"] = "Properties";
    var search = Model?.Search;
}

<div class="container mt-4 mb-5">
    <!-- Page Header -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Browse Properties</h1>
        <p class="lead text-muted">Find your perfect property from our extensive listings</p>
    </div>

    <!-- Search Form -->
    <div class="search-form mb-4">
        <form asp-action="Properties" method="get">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <input type="text" name="SearchTerm" class="form-control" placeholder="Search by title, address, city" value="@search?.SearchTerm">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Property Type</label>
                    <select name="PropertyType" class="form-select">
                        <option value="">All</option>
                        @foreach (var t in Model?.PropertyTypes ?? new List<string>())
                        {
                            @if (t != null)
                            {
                                <option value="@t" selected="@(string.Equals(search?.PropertyType, t, StringComparison.OrdinalIgnoreCase))">@t</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Listing Type</label>
                    <select name="ListingType" class="form-select">
                        <option value="">Any</option>
                        @foreach (var lt in Model?.ListingTypes ?? new List<string>())
                        {
                            <option value="@lt" selected="@(string.Equals(search?.ListingType, lt, StringComparison.OrdinalIgnoreCase))">@lt</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">City</label>
                    <select name="City" class="form-select">
                        <option value="">Any</option>
                        @foreach (var c in Model?.Cities ?? new List<string>())
                        {
                            <option value="@c" selected="@(string.Equals(search?.City, c, StringComparison.OrdinalIgnoreCase))">@c</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Price</label>
                    <input type="number" name="MinPrice" class="form-control" value="@(search?.MinPrice)" min="0">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Max Price</label>
                    <input type="number" name="MaxPrice" class="form-control" value="@(search?.MaxPrice)" min="0">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Bedrooms (min)</label>
                    <input type="number" name="Bedrooms" class="form-control" value="@(search?.Bedrooms)" min="0">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Bathrooms (min)</label>
                    <input type="number" name="Bathrooms" class="form-control" value="@(search?.Bathrooms)" min="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort by</label>
                    <select name="SortBy" class="form-select">
                        <option value="newest" selected="@(search?.SortBy == null || search.SortBy == "newest")">Newest</option>
                        <option value="price_asc" selected="@(search?.SortBy == "price_asc")">Price: Low to High</option>
                        <option value="price_desc" selected="@(search?.SortBy == "price_desc")">Price: High to Low</option>
                        <option value="popular" selected="@(search?.SortBy == "popular")">Most Viewed</option>
                        <option value="oldest" selected="@(search?.SortBy == "oldest")">Oldest</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Page size</label>
                    <select name="PageSize" class="form-select">
                        @foreach (var size in new int[] { 12, 24, 36, 48 })
                        {
                            <option value="@size" selected="@(search?.PageSize == size)">@size</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="col-md-2">
                    <a asp-action="Properties" class="btn btn-outline-secondary w-100">Clear</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Results Count -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Found @(Model?.TotalCount ?? 0) properties</h5>
        <span class="text-muted">Page @(Model?.CurrentPage ?? 1) of @(Model?.TotalPages ?? 1)</span>
    </div>

    <!-- Properties Grid -->
    @if (Model?.Properties != null && Model.Properties.Any())
    {
        <div class="row">
            @foreach (var property in Model.Properties)
            {
                <div class="col-md-4 mb-4">
                    <div class="card property-card h-100 shadow-sm">
                        @if (!string.IsNullOrEmpty(property.MainImage))
                        {
                            <img src="@property.MainImage" class="card-img-top property-image" width="300" height="200" alt="@property.Title">
                        }
                        else
                        {
                            <img src="/images/properties/default.jpg" class="card-img-top property-image" alt="@property.Title">
                        }
                        @if (property.IsFeatured)
                        {
                            <span class="badge bg-warning position-absolute m-2">Featured</span>
                        }
                        <span class="badge bg-@(property.ListingType == "Sale" ? "primary" : "success") position-absolute m-2" style="top: 40px;">
                            @property.ListingType
                        </span>
                        <span class="badge bg-secondary position-absolute m-2" style="top: 80px;">
                            @property.PropertyType
                        </span>
                        <div class="card-body">
                            <h5 class="card-title">@property.Title</h5>
                            <p class="text-muted mb-2">
                                <i class="fas fa-map-marker-alt"></i> @property.City, @property.State
                            </p>
                            <h4 class="text-primary fw-bold mb-3">
                                @CurrencyService.ConvertAndFormatPrice(property.Price)
                                @if (property.ListingType == "Rent")
                                {
                                    <small class="text-muted">/month</small>
                                }
                            </h4>
                            <div class="d-flex justify-content-between text-muted mb-3">
                                @if (property.Bedrooms.HasValue)
                                {
                                    <span><i class="fas fa-bed"></i> @property.Bedrooms BD</span>
                                }
                                @if (property.Bathrooms.HasValue)
                                {
                                    <span><i class="fas fa-bath"></i> @property.Bathrooms BA</span>
                                }
                                @if (property.SquareFeet.HasValue)
                                {
                                    <span><i class="fas fa-ruler-combined"></i> @property.SquareFeet sqft</span>
                                }
                            </div>
                            <div class="d-flex gap-2">
                                <a asp-controller="Home" asp-action="PropertyDetails" asp-route-id="@property.PropertyId"
                                   class="btn btn-primary flex-grow-1">View Details</a>
                                <button class="btn btn-outline-primary" onclick="shareProperty(@property.PropertyId)">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Properties pagination">
                <ul class="pagination justify-content-center">
                    @{
                        var prevDisabled = Model.CurrentPage == 1 ? " disabled" : string.Empty;
                        var nextDisabled = Model.CurrentPage == Model.TotalPages ? " disabled" : string.Empty;
                    }
                    <li class="page-item@prevDisabled">
                        <a class="page-link" asp-action="Properties" asp-route-Page="@(Model.CurrentPage - 1)" asp-route-SearchTerm="@search?.SearchTerm" asp-route-PropertyType="@search?.PropertyType" asp-route-ListingType="@search?.ListingType" asp-route-City="@search?.City" asp-route-MinPrice="@search?.MinPrice" asp-route-MaxPrice="@search?.MaxPrice" asp-route-Bedrooms="@search?.Bedrooms" asp-route-Bathrooms="@search?.Bathrooms" asp-route-SortBy="@search?.SortBy" asp-route-PageSize="@search?.PageSize">Previous</a>
                    </li>
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : string.Empty)">
                            <a class="page-link" asp-action="Properties" asp-route-Page="@i" asp-route-SearchTerm="@search?.SearchTerm" asp-route-PropertyType="@search?.PropertyType" asp-route-ListingType="@search?.ListingType" asp-route-City="@search?.City" asp-route-MinPrice="@search?.MinPrice" asp-route-MaxPrice="@search?.MaxPrice" asp-route-Bedrooms="@search?.Bedrooms" asp-route-Bathrooms="@search?.Bathrooms" asp-route-SortBy="@search?.SortBy" asp-route-PageSize="@search?.PageSize">@i</a>
                        </li>
                    }
                    <li class="page-item@nextDisabled">
                        <a class="page-link" asp-action="Properties" asp-route-Page="@(Model.CurrentPage + 1)" asp-route-SearchTerm="@search?.SearchTerm" asp-route-PropertyType="@search?.PropertyType" asp-route-ListingType="@search?.ListingType" asp-route-City="@search?.City" asp-route-MinPrice="@search?.MinPrice" asp-route-MaxPrice="@search?.MaxPrice" asp-route-Bedrooms="@search?.Bedrooms" asp-route-Bathrooms="@search?.Bathrooms" asp-route-SortBy="@search?.SortBy" asp-route-PageSize="@search?.PageSize">Next</a>
                    </li>
                </ul>
            </nav>
        }
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-search fa-4x text-muted mb-3"></i>
            <h4>No properties found</h4>
            <p class="text-muted">Try adjusting your search filters</p>
            <a asp-action="Properties" class="btn btn-primary">Clear Filters</a>
        </div>
    }
</div>

@section Scripts {
    <script>
        function shareProperty(id) {
            const url = window.location.origin + '/Home/PropertyDetails/' + id;
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this property',
                    url: url
                });
            } else {
                alert('Share URL: ' + url);
            }
        }
    </script>
}